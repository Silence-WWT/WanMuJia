function setCookie(a,b,c){var d=encodeURIComponent(a)+"="+encodeURIComponent(b);return c instanceof Date&&(d+="; expires="+c.toGMTString()),document.cookie=d}function getCookie(a){var b;return decodeURIComponent(document.cookie).split("; ").forEach(function(c){c=c.split("="),a===c[0]&&(b=c[1])}),b}function convertTimeString(a){if("number"!=typeof a)return"";var b=new Date(1e3*a);return b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate()}function getPageTitle(a){return a?$("body").data("page"):$(".page-title").data("page")}function saveInfos(a){var b=["input","select","textarea"],c=["first_category_id","second_category_id","third_category_id"],d={},e=function(a){return c.some(function(b){return b===a})},f=function(a){var b=a.find(".category-select select").not(":hidden");return b.eq(b.length-1).val()};d.csrf_token=a.form.find('[name="csrf_token"]').val(),d.del_components=a.form.data("del-coms"),d.category_id=f(a.form.find(".item-info")),a.form.find(b.map(function(a){return".item-info "+a+".form-control"}).join(",")).each(function(){var a=$(this),b=a.attr("name");e(b)||(d[b]=a.val()||"")});var g=a.form.find(".com-base");g.length>0&&(d.components=[],g.each(function(){var a={},c=$(this);c.find(b.map(function(a){return a+".form-control"}).join(",")).each(function(){var b=$(this),c=b.attr("name"),d=c,f=c.split("-"),g=f.length;g>1&&(d=f.slice(0,g-1).join("-")),e(d)||(a[d]=b.val()||"")}),a.category_id=f(c),d.components.push(a)}),d.components=JSON.stringify(d.components)),$.ajax({url:a.url,method:a.method,data:$.param(d,!0),success:a.success,error:a.error})}function deleteImage(a,b){$.ajax({url:"/vendor/items/image",method:"delete",data:{image_hash:a},success:b})}function formDirtyCheck(a,b){var c=a.serialize(),d=c!==b;return{isDirty:d,origin:d?c:b}}function genImageView(a,b){return'<div class="col-md-3 col-sm-4 col-xs-6 '+(b?"ui-sortable-handle":"")+'"><div class="album-image" data-hash="'+a.hash+'"><a href="#" class="thumb" data-action="edit" data-toggle="modal" data-target="#gallery-image-modal"><img src="'+a.url+'" class="img-responsive" /></a><a href="#" class="name"><span>'+a.name+"</span><em>"+convertTimeString(a.created)+'</em></a><div class="image-options"><a href="#" data-action="trash" data-toggle="modal" data-target="#gallery-image-delete-modal"><i class="fa-trash"></i></a></div></div></div>'}function setElemText(a,b){a.is("input")?a.val(b):a.text(b)}function sendEnable(a,b){setElemText(a,b),a.removeClass("disabled")}function sendDisable(a,b,c){var d=parseInt((c-b+parseInt(getCookie("clickTime")))/1e3);a.addClass("disabled"),setElemText(a,d+" 秒后点击再次发送")}function setCountDown(a,b,c){var d=setInterval(function(){Date.now()-getCookie("clickTime")>=c-1e3?(clearTimeout(d),sendEnable(a,b),setCookie("clickTime","",new Date(0))):sendDisable(a,Date.now(),c)},200)}function setButtonLoading(a){a.addClass("disabled").html('<i><span class="fa fa-spin fa-spinner"></span></i>')}function resetButton(a,b){a.removeClass("disabled").html(b)}function checkValidate(a,b){if(a.hasClass("validate")){var c=null,d=a.find(b);if(b){if(!(d.length>0))return;c=d.valid()}else c=a.valid();if(!c)return a.data("validator").focusInvalid(),!1}return!0}jQuery(document).ready(function(a){function b(a,b){a.dataTable({aLengthMenu:[[10,25,50,100,-1],[10,25,50,100,"All"]],language:{sProcessing:"处理中...",sLengthMenu:"显示 _MENU_ 项结果",sZeroRecords:"没有匹配结果",sInfo:"显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",sInfoEmpty:"显示第 0 至 0 项结果，共 0 项",sInfoFiltered:"(由 _MAX_ 项结果过滤)",sInfoPostFix:"",sSearch:"搜索:",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上页",sNext:"下页",sLast:"末页"},oAria:{sSortAscending:": 以升序排列此列",sSortDescending:": 以降序排列此列"}},processing:!0,serverSide:!0,ajax:b.ajax,columns:b.columns,columnDefs:b.columnDefs})}a.validator&&(a.validator.addMethod("regex",function(a,b,c){return c.constructor!=RegExp?c=new RegExp(c):c.global&&(c.lastIndex=0),this.optional(b)||c.test(a)},"Please check your input."),a.validator.addMethod("mobile",function(a,b){var c=a.length,d=/^((1[3-8][0-9])+\d{8})$/;return this.optional(b)||11==c&&d.test(a)}),a.validator.addMethod("tel",function(a,b){var c=/^\d{3,4}-?\d{7,9}$/;return this.optional(b)||c.test(a)}),a.validator.addMethod("identity",function(a,b){var c=/^\d{15}(\d\d[0-9xX])?$/;return this.optional(b)||c.test(a)}),a.validator.addMethod("password",function(a,b){var c=/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,}$/;return this.optional(b)||c.test(a)}),a.validator.addMethod("customDate",function(a,b){var c=/^(\d{4})\/((0?([1-9]))|(1[0|1|2]))\/((0?[1-9])|([12]([0-9]))|(3[0|1]))$/;return this.optional(b)||c.test(a)}),a.validator.addMethod("sizeRequired",function(b,c){var d=a(c),e=d.attr("id").split("-"),f=e.length,g=f>1?"-"+e[f-1]:"",h=a("#area"+g);return h.length<1?!!d.val():!!h.val()||!!d.val()}),a.validator.addMethod("areaRequired",function(b,c){var d=a(c),e=d.attr("id").split("-"),f=e.length,g=f>1?"-"+e[f-1]:"",h=a("#length"+g);return h.length<1?!!d.val():!!(h.val()||a("#width"+g).val()||a("#height"+g).val()||d.val())}));var c={initDropzone:function(b,c){b.dropzone({url:c.url,method:"put",acceptedFiles:"image/jpg, image/jpeg, image/png",addRemoveLinks:"item-edit"!==getPageTitle(),dictDefaultMessage:"拖动文件到此以上传",dictResponseError:"服务器{{ statusCode }}错误, 上传失败, 请稍后重试。",dictCancelUpload:"取消上传",dictCancelUploadConfirmation:"确定取消上传吗？",dictRemoveFile:"移除文件",init:function(){this.on("sending",function(b,d,e){a.ajax({url:"/vendor/items/oss_signature",method:"get",data:{item_id:c.itemId,filename:b.name},async:!1,success:function(a){var b=a.params;a.success&&(d.open("post",a.url),Object.keys(b).forEach(function(a){e.append(a,b[a])}))}})}).on("removedfile",function(b){var c=a(b.previewElement).data("hash");c&&deleteImage(c)}).on("success",c.success)}})},setPreviewError:function(b,c){a(b.previewElement).removeClass("dz-success").addClass("dz-error").find(".dz-error-message span").text("上传失败!"+c)}},d={closeButton:!0,debug:!1,positionClass:"toast-top-full-width",onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},e=null;if("items"===getPageTitle()){var f=a("#delete-confirm-form");b(a("#items"),{ajax:"/vendor/items/datatable",columns:[{data:"id",bSortable:!1,visible:!1},{data:"item",bSortable:!1},{data:"scene_id",bSortable:!1},{data:"price"},{data:"size",bSortable:!1}],columnDefs:[{targets:[5],data:"id",render:function(a){return"<a href='/vendor/items/"+a+"'>详情/编辑</a>"}},{targets:[6],data:{},render:function(a){return'<a href="javascript:void(0)" data-item="'+a.item+'" data-item-id="'+a.id+'" data-toggle="modal" data-target="#delete-confirm-modal">删除商品</a>'}}]}),a("#items").delegate('[data-target="#delete-confirm-modal"]',"click",function(){var b=a(this),c=b.data("item-id"),d=b.data("item");f.data("item-id",c),a("#modal-item-name").text(d)}),a("#modal-item-delete").click(function(b){a.ajax({url:"/vendor/items/"+f.data("item-id"),method:"delete",success:function(){window.location.reload()},error:function(){window.location.reload()}}),b.preventDefault()})}if("item-edit"===getPageTitle()){var g=a("#edit-item-form"),h=g.serialize();g.find(".return-list a").off("click"),g.delegate(".form-control","keydown",function(){a("#save").next().hide()}),g.find("select").click(function(){a("#save").next().hide()}),a("#save").click(function(){var b=a(this),c=b.html();if(!b.hasClass("disabled")){var d=formDirtyCheck(g,h);d.isDirty?(setButtonLoading(b),saveInfos({url:window.location.path,method:"put",form:g,success:function(a){a.success?toastr.success("保存成功!"):toastr.error(a.message,"提交失败!"),h=d.origin,resetButton(b,c)},error:function(a){toastr.error("服务器"+a.status+"错误","提交失败!"),resetButton(b,c)}})):toastr.warning("没有修改内容!")}});var i=a(".album-images"),j=function(){var b=[];return i.find(".album-image").each(function(){b.push(a(this).data("hash"))}),b},k=j();c.initDropzone(a("#img-upload"),{url:"/vendor/items/image?item_id="+g.data("item-id"),itemId:g.data("item-id"),success:function(b,d){var e=a(b.previewElement);if(d.success){var f=d.image;e.data("hash",f.hash),i.length>0&&(i.append(a(genImageView({name:b.name,hash:f.hash,url:f.url,created:f.created},i.hasClass("ui-sortable")?!0:!1))),k.push(f.hash))}else c.setPreviewError(b,d.message)}});var l="";i.delegate('[data-action="trash"]',"click",function(){l=a(this).parents(".album-image").data("hash")}).delegate(".album-image","click",function(){var b=a(this).find(".thumb img").attr("src");a("#gallery-image-modal").find("img").attr("src",b)}),a("#gallery-image-delete-modal").find("#delete").click(function(){i.find("[data-hash="+l+"]").parent().remove(),deleteImage(l,function(a){if(a.success){var b=k.indexOf(deleteImage);k.splice(b,1)}})}),a("#sort-confirm").click(function(){var b=j();console.log(k,b),b.toString()==k.toString()?toastr.success("保存顺序成功!"):a.ajax({url:"/vendor/items/image_sort",method:"post",data:{item_id:g.data("item-id"),images:b.join(",")},success:function(a){a.success?(toastr.success("保存顺序成功!"),k=b):toastr.error(a.message,"保存顺序失败! 请重新保存~")},error:function(a){toastr.error("服务器"+a.status+"错误...","保存顺序失败! 请重新保存~")}})})}if("item-new"===getPageTitle()){var m=a("#new-item-form"),n=function(){var b=a(this);if(!b.hasClass("disabled")&&checkValidate(m)){var d=b.children("a"),e=d.html(),f=window.location.search;b.addClass("disabled"),d.html('<i><span class="fa fa-spin fa-spinner"></span></i>'),saveInfos({url:"/vendor/items/new_item"+f,method:"post",form:a("#new-item-form"),success:function(f){f.success?(toastr.success("您可以继续添加商品图片","商品添加成功!"),c.initDropzone(a("#img-upload"),{url:"http://wanmujia.oss-cn-beijing.aliyuncs.com/images/item/",itemId:f.item_id,success:function(b,d){var e=a(b.previewElement);if(d.success){var f=d.image;e.data("hash",f.hash)}else c.setPreviewError(b,d.message)}}),m.bootstrapWizard("next"),b.hide(),m.find(".add-another").show().children("a").off("click"),m.find(".return-list").show().children("a").off("click")):(toastr.error(f.message,"提交失败"),b.removeClass("disabled")),d.html(e)},error:function(a){toastr.error("服务器"+a.status+"错误","提交失败"),d.html(e),b.removeClass("disabled")}})}};a(".wizard .next").off("click").click(n),a('[id|="length"]').each(function(){a(this).rules("add",{sizeRequired:!0,messages:{sizeRequired:"请填写商品长度"}})}),a('[id|="width"]').each(function(){a(this).rules("add",{sizeRequired:!0,messages:{sizeRequired:"请填写商品宽度"}})}),a('[id|="height"]').each(function(){a(this).rules("add",{sizeRequired:!0,messages:{sizeRequired:"请填写商品高度"}})}),a('[id|="area"]').each(function(){a(this).rules("add",{areaRequired:!0,messages:{areaRequired:"请填写商品适用面积"}})})}if("distributors"===getPageTitle()){var o=a("#distributors");b(o,{ajax:"/vendor/distributors/datatable",columns:[{data:"id",bSortable:!1,visible:!1},{data:"name"},{data:"address",bSortable:!1},{data:"contact_telephone",bSortable:!1},{data:"contact_mobile",bSortable:!1},{data:"contact",bSortable:!1},{data:"created"},{data:"revocation_state",visible:!1}],columnDefs:[{targets:[8],data:{},render:function(a){var b=function(b){return'<a href="javascript:void(0)" data-toggle="modal" data-target="#revocation-modal" data-dist-name="'+a.name+'" data-dist-id="'+a.id+'">'+b+"</a>"};return console.log(a.revocation_state),"pending"==a.revocation_state?'<span class="text-warning">审核中</span>':"revocated"==a.revocation_state?'<span class="text-success">已取消授权</span>':"rejected"==a.revocation_state?'<span class="text-danger">审核失败;</span>'+b("点击再次提交审核"):b("取消授权")}}]}),a("#distributors").delegate('[data-target="#revocation-modal"]',"click",function(){var b=a(this).data("dist-id"),c=a(this).data("dist-name"),d=a("#contract-form"),e=d.attr("action").split("/");e[3]=b,a("#modal-dist-name").text(c),a("#contract").val(""),d.attr("action",e.join("/"))})}if("dist-invitation"===getPageTitle()&&a("#get-key").click(function(){var b=a(this);if(!b.hasClass("disabled")){var c=b.text();setButtonLoading(b),a.ajax({url:"/vendor/distributors/invitation",method:"post",success:function(d){a(".invite-key").val(d).attr("contenteditable",!0).focus().select(),resetButton(b,c)},error:function(a){toastr.error("服务器"+a.status+"错误.","申请失败!"),resetButton(b,c)}})}}),"settings"===getPageTitle()&&(a("#logo").on("change",function(){var b=a(this),c=this.files?this.files:[];if(!(c.length<=0)&&window.FileReader&&/^image/.test(c[0].type)){var d=new FileReader;d.readAsDataURL(c[0]),d.onloadend=function(){b.siblings(".logo-preview").find("img").attr("src",this.result)}}}),a("#mobile").rules("add",{mobile:!0,messages:{mobile:"手机号码格式不正确"}}),a("#telephone").rules("add",{tel:!0,messages:{tel:"固定电话号码格式不正确"}}),a("#send-email").click(function(){var b=a(this).data("vendor-id");a.ajax({url:"/service/send_email?type=VENDOR_EMAIL_CONFIRM",method:"post",data:{csrf_token:a("#csrf_token").val(),role:"vendor",id:b},success:function(a){a.success?toastr.success("验证邮件已发送, 请查收","发送成功!"):toastr.error(a.message,"发送失败!")},error:function(a){toastr.error("服务器"+a.status+"错误...","发送失败!")}})})),"register"==(e=getPageTitle(!0))||"initialization"==e){var p=a(".send"),q=a("#"+e),r=6e4,s=p.val()||p.text();a("#mobile").rules("add",{required:!0,mobile:!0,messages:{required:"请输入您的手机号",mobile:"手机号码格式不正确"}}),a("#captcha").rules("add",{required:!0,messages:{required:"请填写手机验证码"}}),"initialization"==e&&a("#password").rules("add",{required:!0,password:!0,messages:{required:"请设置密码",password:"密码长度必须大于等于6位且为字母和数字的组合"}}),getCookie("clickTime")&&(sendDisable(p,Date.now(),r),setCountDown(p,s,r)),p.click(function(){if(checkValidate(q,"#mobile")){var b=a(this);b.hasClass("disabled")||(setCookie("clickTime",Date.now()),a.ajax({url:"/service/mobile_register_sms",method:"post",data:{mobile:a("#mobile").val()},success:function(a){return a.success?void setCountDown(b,s,r):void toastr.error(a.message,"验证码发送失败!",d)},error:function(a){toastr.error("服务器"+a.status+"错误...","验证码发送失败!",d),setCountDown(b,s,r)}}))}})}("register-next"==(e=getPageTitle(!0))||"reconfirm"==e)&&("register-next"==e&&(a("#email").rules("add",{required:!0,email:!0,messages:{required:"请输入您的邮箱",email:"邮箱地址格式不正确"}}),a("#password").rules("add",{required:!0,password:!0,messages:{required:"请设置密码",password:"密码长度必须大于等于6位且为字母和数字的组合"}}),a("#confirm_password").rules("add",{required:!0,equalTo:"#password",password:!1,messages:{required:"请再次输入密码",equalTo:"两次密码输入不一致"}}),a("#agent_identity_front").rules("add",{required:!0,messages:{required:"请上传代理人身份证正面照片"}}),a("#agent_identity_back").rules("add",{required:!0,messages:{required:"请上传代理人身份证反面照片"}}),a("#license_image").rules("add",{required:!0,messages:{required:"请上传营业执照照片"}})),a("#agent_name").rules("add",{required:!0,messages:{required:"请输入代理人姓名"}}),a("#agent_identity").rules("add",{required:!0,identity:!0,messages:{required:"请输入代理人身份证",identity:"身份证号码格式不正确"}}),a("#brand").rules("add",{required:!0,messages:{required:"请填写品牌名称"}}),a("#name").rules("add",{required:!0,messages:{required:"请填写公司名称"}}),a("#license_limit").rules("add",{required:!0,customDate:!0,messages:{required:"请填写营业期限",customDate:"日期格式不正确, 格式: 2015/07/19"}}),a("#telephone").rules("add",{required:!0,tel:!0,messages:{required:"请填写联系固话",tel:"电话号码格式不正确"}}),a("#province_cn_id").rules("add",{required:!0,messages:{required:"请选择省级行政区"}}),a("#city_cn_id").rules("add",{required:!0,messages:{required:"请选择市级行政区"}}),a("#district_cn_id").rules("add",{required:!0,messages:{required:"请选择区级行政区"}}),a("#address").rules("add",{required:!0,messages:{required:"请填写联系地址"}}))});