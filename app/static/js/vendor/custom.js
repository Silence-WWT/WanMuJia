function setCookie(e,a,t){var i=encodeURIComponent(e)+"="+encodeURIComponent(a);return t instanceof Date&&(i+="; expires="+t.toGMTString()),document.cookie=i}function getCookie(e){var a;return decodeURIComponent(document.cookie).split("; ").forEach(function(t){t=t.split("="),e===t[0]&&(a=t[1])}),a}function convertTimeString(e){if("number"!=typeof e)return"";var a=new Date(1e3*e);return a.getFullYear()+"-"+a.getMonth()+"-"+a.getDay()}function getPageTitle(){return $(".page-title").data("page")}function saveInfos(e){$.ajax({url:e.url,method:e.method,data:e.form.serialize(),success:e.success,error:e.error})}function deleteImage(e){$.ajax({url:"/vendor/item_image",method:"put",data:{image_hash:e}})}function formDirtyCheck(e,a){var t=e.serialize(),i=t!==a;return{isDirty:i,origin:i?t:a}}function genImageView(e){return'<div class="col-md-3 col-sm-4 col-xs-6"><div class="album-image" data-hash="'+e.hash+'"><a href="#" class="thumb" data-action="edit" data-toggle="modal" data-target="#gallery-image-modal"><img src="'+e.url+'" class="img-responsive" /></a><a href="#" class="name"><span>'+e.name+"</span><em>"+convertTimeString(e.created)+'</em></a><div class="image-options"><a href="#" data-action="trash" data-toggle="modal" data-target="#gallery-image-delete-modal"><i class="fa-trash"></i></a></div></div></div>'}function setElemText(e,a){e.is("input")?e.val(a):e.text(a)}function sendEnable(e,a){setElemText(e,a),e.removeClass("disabled")}function sendDisable(e,a,t){var i=parseInt((t-a+parseInt(getCookie("clickTime")))/1e3);e.addClass("disabled"),setElemText(e,i+" 秒后点击再次发送")}function setCountDown(e,a,t){var i=setInterval(function(){Date.now()-getCookie("clickTime")>=t-1e3?(clearTimeout(i),sendEnable(e,a),setCookie("clickTime","",new Date(0))):sendDisable(e,Date.now(),t)},200)}function setButtonLoading(e){e.addClass("disabled").html('<i><span class="fa fa-spin fa-spinner"></span></i>')}function resetButton(e,a){e.removeClass("disabled").html(a)}function checkValidate(e,a){if(e.hasClass("validate")){var t=null,i=e.find(a);if(a){if(!(i.length>0))return;t=i.valid()}else t=e.valid();if(!t)return e.data("validator").focusInvalid(),!1}return!0}jQuery(document).ready(function(e){function a(e,a){e.dataTable({aLengthMenu:[[10,25,50,100,-1],[10,25,50,100,"All"]],language:{sProcessing:"处理中...",sLengthMenu:"显示 _MENU_ 项结果",sZeroRecords:"没有匹配结果",sInfo:"显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",sInfoEmpty:"显示第 0 至 0 项结果，共 0 项",sInfoFiltered:"(由 _MAX_ 项结果过滤)",sInfoPostFix:"",sSearch:"搜索:",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上页",sNext:"下页",sLast:"末页"},oAria:{sSortAscending:": 以升序排列此列",sSortDescending:": 以降序排列此列"}},processing:!0,serverSide:!0,ajax:a.ajax,columns:a.columns,columnDefs:a.columnDefs})}e.validator&&(e.validator.addMethod("regex",function(e,a,t){return t.constructor!=RegExp?t=new RegExp(t):t.global&&(t.lastIndex=0),this.optional(a)||t.test(e)},"Please check your input."),e.validator.addMethod("mobile",function(e,a){var t=e.length,i=/^((1[3-8][0-9])+\d{8})$/;return this.optional(a)||11==t&&i.test(e)}),e.validator.addMethod("tel",function(e,a){var t=/^\d{3,4}-?\d{7,9}$/;return this.optional(a)||t.test(e)}));var t=e("#img-upload.dropzone");t.length>0&&t.dropzone({url:"/vendor/items/image",method:"put",acceptedFiles:"image/jpg, image/jpeg, image/png",addRemoveLinks:"item-edit"!==getPageTitle(),dictDefaultMessage:"拖动文件到此以上传",dictResponseError:"服务器错误, 上传失败, 请稍后重试。",dictCancelUpload:"取消上传",dictCancelUploadConfirmation:"确定取消上传吗？",dictRemoveFile:"移除文件",init:function(){this.on("removedfile",function(a){console.log(a.previewElement);var t=e(a.previewElement).data("hash");t&&deleteImage(t)}).on("success",function(a,t){e(a.previewElement).data("hash",t.hash);var i=e(".album-images");i.length>0&&i.append(e(genImageView({name:a.name,hash:t.hash,url:t.url,created:t.created})))})}});if("items"===getPageTitle()&&a(e("#items"),{ajax:"/vendor/items/datatable",columns:[{data:"id",bSortable:!1,visible:!1},{data:"item",bSortable:!1},{data:"second_category_id",bSortable:!1},{data:"price"},{data:"size",bSortable:!1}],columnDefs:[{targets:[5],data:"id",render:function(e){return"<a href='/vendor/items/"+e+"'>详情/编辑</a>"}}]}),"item-edit"===getPageTitle()){var i=e("#edit-item-form"),s=i.serialize();i.delegate(".form-control","keydown",function(){e("#save").next().hide()}),i.find("select").click(function(){e("#save").next().hide()}),e("#save").click(function(){var a=e(this),t=a.html();if(!a.hasClass("disabled")){var r=formDirtyCheck(i,s);r.isDirty?(setButtonLoading(a),saveInfos({url:window.location.pathname,method:"put",form:i,success:function(e){e.success?toastr.success("保存成功!"):toastr.error(e.message,"提交失败!"),s=r.origin,resetButton(a,t)},error:function(e){toastr.error("服务器"+e.status+"错误","提交失败!"),resetButton(a,t)}})):toastr.warning("没有修改内容!")}});var r=e(".album-images"),n="";r.delegate('[data-action="trash"]',"click",function(){console.log("delete"),n=e(this).parents(".album-image").data("hash")}).delegate(".album-image","click",function(){var a=e(this).find(".thumb img").attr("src");e("#gallery-image-modal").find("img").attr("src",a)}),e("#gallery-image-delete-modal").find("#delete").click(function(){r.find("[data-hash="+n+"]").parent().remove(),deleteImage(n)}),e("#sort-confirm").click(function(){var a=[];r.find(".album-image").each(function(){a.push(e(this).data("hash"))}),e.ajax({url:"/items/image_sort",method:"post",data:a.join(",")})})}if("item-new"===getPageTitle()){var o=e("#new-item-form"),d=function(){var a=e(this);if(!a.hasClass("disabled")&&checkValidate(o)){var t=a.children("a"),i=t.html();a.addClass("disabled"),t.html('<i><span class="fa fa-spin fa-spinner"></span></i>'),saveInfos({url:"/vendor/items/new_item",method:"post",form:e("#new-item-form"),success:function(e){e.success?o.bootstrapWizard("next"):toastr.error(e.message,"提交失败"),t.html(i),a.removeClass("disabled")},error:function(e){toastr.error("服务器"+e.status+"错误","提交失败"),t.html(i),a.removeClass("disabled")}})}};e(".wizard .next").off("click").click(d)}if("distributors"===getPageTitle()){var l=e("#distributors");a(l,{ajax:"/vendor/items/datatable",columns:[{data:"id",bSortable:!1,visible:!1},{data:"item",bSortable:!1},{data:"second_category_id",bSortable:!1},{data:"price"},{data:"size",bSortable:!1}],columnDefs:[{targets:[5],data:"id",render:function(e){return"<a href='/vendor/items/"+e+"'>详情/编辑</a>"}}]}),e("#distributors").delegate('[data-target="#revocation-modal"]',"click",function(){var a=e(this).data("dist-id"),t=e("#contract-form"),i=t.attr("action").split("/");i[3]=a,t.attr("action",i.join("/"))})}if("dist-invitation"===getPageTitle()&&e("#get-key").click(function(){e.ajax({url:"/vendor/distributors/invitation",method:"post",success:function(a){e(".invite-key").text(a)},error:function(){}})}),"settings"===getPageTitle()&&(e("#logo").on("change",function(){var a=e(this),t=this.files?this.files:[];if(!(t.length<=0)&&window.FileReader&&/^image/.test(t[0].type)){var i=new FileReader;i.readAsDataURL(t[0]),i.onloadend=function(){a.siblings(".logo-preview").find("img").attr("src",this.result)}}}),e("#contact_mobile").rules("add",{mobile:!0,messages:{mobile:"请填写合法的手机号码"}}),e("#contact_telephone").rules("add",{tel:!0,messages:{tel:"请填写合法的固定电话号码"}})),"register"==e("body").data("page")){var c=e(".send"),u=6e4,m=c.val()||c.text();getCookie("clickTime")&&(sendDisable(c,Date.now(),u),setCountDown(c,m,u)),c.click(function(){if(checkValidate(e("#register"),"#mobile")){var a=e(this);a.hasClass("disabled")||(setCookie("clickTime",Date.now()),e.ajax({url:"/service/mobile_register_sms",method:"post",data:{mobile:e("#mobile").val()}}),setCountDown(a,m,u))}})}("register-next"==e("body").data("page")||"reconfirm"==e("body").data("page"))&&("register-next"==e("body").data("page")&&(e("#email").rules("add",{required:!0,email:!0,messages:{required:"请输入您的邮箱",email:"请输入合法的邮箱地址"}}),e("#password").rules("add",{required:!0,regex:/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{6,}$/,messages:{required:"请设置密码",regex:"密码长度必须大于等于6位且为字母和数字的组合"}}),e("#confirm_password").rules("add",{required:!0,equalTo:"#password",messages:{required:"请再次输入密码",equalTo:"两次密码输入不一致"}}),e("#agent_identity_front").rules("add",{required:!0,messages:{required:"请上传代理人身份证正面照片"}}),e("#agent_identity_back").rules("add",{required:!0,messages:{required:"请上传代理人身份证反面照片"}})),e("#agent_name").rules("add",{required:!0,messages:{required:"请输入代理人姓名"}}),e("#agent_identity").rules("add",{required:!0,regex:/^\d{15}(\d\d[0-9xX])?$/,messages:{required:"请输入代理人身份证",regex:"不合法的身份证号码"}}),e("#name").rules("add",{required:!0,messages:{required:"请填写厂家名称"}}),e("#license_address").rules("add",{required:!0,messages:{required:"请填写营业执照所在地"}}),e("#limit").rules("add",{required:!0,messages:{required:"请填写营业期限"}}),e("#province_cn_id").rules("add",{required:!0,messages:{required:"请选择省级行政区"}}),e("#city_cn_id").rules("add",{required:!0,messages:{required:"请选择市级行政区"}}),e("#district_cn_id").rules("add",{required:!0,messages:{required:"请选择区级行政区"}}),e("#address").rules("add",{required:!0,messages:{required:"请填写联系地址"}}))});