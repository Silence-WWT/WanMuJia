function setCookie(e,t,a){var i=encodeURIComponent(e)+"="+encodeURIComponent(t);return a instanceof Date&&(i+="; expires="+a.toGMTString()),document.cookie=i}function getCookie(e){var t;return decodeURIComponent(document.cookie).split("; ").forEach(function(a){a=a.split("="),e===a[0]&&(t=a[1])}),t}function convertTimeString(e){if("number"!=typeof e)return"";var t=new Date(1e3*e);return t.getFullYear()+"-"+t.getMonth()+"-"+t.getDay()}function getPageTitle(){return $(".page-title").data("page")}function saveInfos(e){$.ajax({url:e.url,method:e.method,data:e.form.serialize(),success:e.success,error:e.error})}function deleteImage(e){$.ajax({url:"/vendor/item_image",method:"put",data:{image_hash:e}})}function formDirtyCheck(e,t){var a=e.serialize(),i=a!==t;return{isDirty:i,origin:i?a:t}}function genImageView(e){return'<div class="col-md-3 col-sm-4 col-xs-6"><div class="album-image" data-hash="'+e.hash+'"><a href="#" class="thumb" data-action="edit" data-toggle="modal" data-target="#gallery-image-modal"><img src="'+e.url+'" class="img-responsive" /></a><a href="#" class="name"><span>'+e.name+"</span><em>"+convertTimeString(e.created)+'</em></a><div class="image-options"><a href="#" data-action="trash" data-toggle="modal" data-target="#gallery-image-delete-modal"><i class="fa-trash"></i></a></div></div></div>'}function setElemText(e,t){e.is("input")?e.val(t):e.text(t)}function sendEnable(e,t){setElemText(e,t),e.removeClass("disabled")}function sendDisable(e,t,a){var i=parseInt((a-t+parseInt(getCookie("clickTime")))/1e3);e.addClass("disabled"),setElemText(e,i+" 秒后点击再次发送")}function setCountDown(e,t,a){var i=setInterval(function(){Date.now()-getCookie("clickTime")>=a-1e3?(clearTimeout(i),sendEnable(e,t),setCookie("clickTime","",new Date(0))):sendDisable(e,Date.now(),a)},200)}function setFormDisabled(e){e.find(".form-control").attr("disabled",!0)}function genDataAttrStr(e){var t="";for(var a in e)t+="data-"+a+'="'+e[a]+'"';return t}function setDlData(e,t,a){e.find('[id|="'+t+'"]').each(function(){var e=this.id.split("-")[1],t=a[e],i=$(this).next();i.children("img").length>0?i.children("img").attr("src",t):i.text(t)})}jQuery(document).ready(function(e){function t(e,t){e.dataTable({aLengthMenu:[[10,25,50,100,-1],[10,25,50,100,"All"]],language:{sProcessing:"处理中...",sLengthMenu:"显示 _MENU_ 项结果",sZeroRecords:"没有匹配结果",sInfo:"显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",sInfoEmpty:"显示第 0 至 0 项结果，共 0 项",sInfoFiltered:"(由 _MAX_ 项结果过滤)",sInfoPostFix:"",sSearch:"搜索:",sUrl:"",sEmptyTable:"表中数据为空",sLoadingRecords:"载入中...",sInfoThousands:",",oPaginate:{sFirst:"首页",sPrevious:"上页",sNext:"下页",sLast:"末页"},oAria:{sSortAscending:": 以升序排列此列",sSortDescending:": 以降序排列此列"}},processing:!0,serverSide:!0,ajax:t.ajax,columns:t.columns,columnDefs:t.columnDefs})}e.validator&&(e.validator.addMethod("regex",function(e,t,a){return a.constructor!=RegExp?a=new RegExp(a):a.global&&(a.lastIndex=0),this.optional(t)||a.test(e)},"Please check your input."),e.validator.addMethod("mobile",function(e,t){var a=e.length,i=/^((1[3-8][0-9])+\d{8})$/;return this.optional(t)||11==a&&i.test(e)}),e.validator.addMethod("tel",function(e,t){var a=/^\d{3,4}-?\d{7,9}$/;return this.optional(t)||a.test(e)}));var a=e("#img-upload.dropzone");if(a.length>0&&a.dropzone({url:"/vendor/item_image",method:"put",acceptedFiles:"image/jpg, image/jpeg, image/png",addRemoveLinks:"item-edit"!==getPageTitle(),dictDefaultMessage:"拖动文件到此以上传",dictResponseError:"服务器错误, 上传失败, 请稍后重试。",dictCancelUpload:"取消上传",dictCancelUploadConfirmation:"确定取消上传吗？",dictRemoveFile:"移除文件",init:function(){this.on("removedfile",function(t){console.log(t.previewElement);var a=e(t.previewElement).data("hash");a&&deleteImage(a)}).on("success",function(t,a){e(t.previewElement).data("hash",a.hash);var i=e(".album-images");i.length>0&&i.append(e(genImageView({name:t.name,hash:a.hash,url:a.url,created:a.created})))})}}),"items"===getPageTitle()&&t(e("#items"),{ajax:"/privilege/items/datatable",columns:[{data:"id",bSortable:!1,visible:!1},{data:"item",bSortable:!1},{data:"vendor"},{data:"second_category_id",bSortable:!1},{data:"price"},{data:"size",bSortable:!1}],columnDefs:[{targets:[6],data:"id",render:function(e){return"<a href='/privilege/items/"+e+"'>详情</a>"}}]}),"item-detail"===getPageTitle()){setFormDisabled($form);var i=e(".album-images");i.delegate(".album-image","click",function(){var t=e(this).find(".thumb img").attr("src");e("#gallery-image-modal").find("img").attr("src",t)})}if("distributors"===getPageTitle()&&t(e("#distributors"),{ajax:"/privilege/distributors/datatable",columns:[{data:"id",bSortable:!1,visible:!1},{data:"name",bSortable:!1},{data:"address",bSortable:!1},{data:"contact_telephone",bSortable:!1},{data:"contact_mobile",bSortable:!1},{data:"contact",bSortable:!1},{data:"created",bSortable:!1}]}),"vendors"===getPageTitle()&&t(e("#vendors"),{ajax:"/privilege/vendors/datatable",columns:[{data:"id",bSortable:!1,visible:!1},{data:"name",bSortable:!1},{data:"address",bSortable:!1},{data:"license_limit",bSortable:!1},{data:"mobile",bSortable:!1},{data:"telephone",bSortable:!1}],columnDefs:[{targets:[6],data:"id",render:function(e){return"<a href='/privilege/vendors/"+e+"'>详情</a>"}}]}),"vendor-detail"===getPageTitle()&&(setFormDisabled(e("#vendor-detail-form")),e("#logo").on("change",function(){var t=e(this),a=this.files?this.files:[];if(!(a.length<=0)&&window.FileReader&&/^image/.test(a[0].type)){var i=new FileReader;i.readAsDataURL(a[0]),i.onloadend=function(){t.siblings(".logo-preview").find("img").attr("src",this.result)}}})),"vendor-confirm"===getPageTitle()){var o={vId:null,dId:null,confirmedVendor:{},confirmedDist:{},setVid:function(e){this.vId=e,this.dId=null},setDid:function(e){this.dId=e,this.vId=null},setCurrentIdConfirmed:function(){this.vId?this.confirmedVendor[this.vId]=!0:this.dId&&(this.confirmedDist[this.dId]=!0)},unsetConfirmed:function(e,t){"vendor"===e?(console.log("vendor unset"),this.confirmedVendor[t]=!1):"distributor"===e&&(console.log("dist unset"),this.confirmedDist[t]=!1)},isConfirmed:function(){return this.vId&&this.confirmedVendor[this.vId]||this.dId&&this.confirmedDist[this.dId]?!0:!1}};t(e("#vendors"),{ajax:"/privilege/vendors/confirm/datatable",columns:[{data:"id",visible:!1},{data:"email",visible:!1},{data:"mobile",visible:!1},{data:"telephone",visible:!1},{data:"agent_name",visible:!1},{data:"agent_identity",visible:!1},{data:"agent_identity_front",visible:!1},{data:"agent_identity_back",visible:!1},{data:"name",bSortable:!1},{data:"address",bSortable:!1},{data:"license_limit",bSortable:!1},{data:"telephone",bSortable:!1}],columnDefs:[{targets:[12],render:function(){return'<span class="state">未审核</span>'}},{targets:[13],data:{},render:function(e){return'<a class="vendor-op" href="javascript:void(0);" '+genDataAttrStr(e)+'data-state="未审核" data-toggle="modal" data-target="#confirm-modal">详情/操作</a>'}}]}),t(e("#distributors"),{ajax:"/privilege/distributors/revocation/datatable",columns:[{data:"id",visible:!1},{data:"contact_telephone",visible:!1},{data:"contract",visible:!1},{data:"name",bSortable:!1},{data:"address",bSortable:!1},{data:"contact_mobile",bSortable:!1},{data:"contact",bSortable:!1}],columnDefs:[{targets:[8],data:{},render:function(e){return'<a class="dist-op" href="javascript:void(0);" '+genDataAttrStr(e)+' data-toggle="modal" data-target="#revocation-modal">详情/操作</a>'}}]}),e("#vendors").delegate(".vendor-op","click",function(){var t=e("#confirm-modal .modal-footer button[data-action]"),a=e(this);o.setVid(a.data("id")),setDlData(e("#confirm-modal"),"vendor",a.data()),o.isConfirmed()?t.addClass("disabled"):t.removeClass("disabled")}),e("#distributors").delegate(".dist-op","click",function(){var t=e("#revocation-modal .modal-footer button[data-action]"),a=e(this);o.setDid(a.data("id")),setDlData(e("#revocation-modal"),"dist",a.data()),o.isConfirmed()?t.addClass("disabled"):t.removeClass("disabled")}),e(".modal-footer button[data-action]").click(function(){var t=e(this);if(!t.hasClass("disabled")){var a=null,i=null,n=null,d=null,r=null,s=null,l=null;"vendor"==t.data("role")?(n="vendor",d=o.vId,a=e('#vendors a[data-id="'+d+'"]'),"accept"==t.data("action")?(r="/privilege/vendor_confirm/pass",l="已接受"):(r="/privilege/vendor_confirm/reject",l="已拒绝"),s={vendor_id:d}):"distributor"==t.data("role")&&(n="distributor",d=o.dId,a=e('#distributors a[data-id="'+d+'"]'),r="/privilege/distributors/revocation",s.distributor_revocation_id=d,"accept"==t.data("action")?(l="已同意",s.revocation_confirm=!0):(l="已驳回",s.revocation_confirm=!1)),i=a.parents("tr").find(".state"),i.removeClass("text-danger").text("处理中..."),o.setCurrentIdConfirmed(),e.ajax({url:r,method:"post",data:s,success:function(){i.removeClass("text-danger").addClass("text-success").text(l),a.data("state",l),console.log(a.data("state"))},error:function(){i.removeClass("text-danger").addClass("text-danger").text("服务器错误请重试"),o.unsetConfirmed(n,d)}})}})}});